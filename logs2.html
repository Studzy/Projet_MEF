<!doctype html>
<html lang="fr">
<head>
	<meta charset="UTF-8">
	<script src="js/Jquery/jquery-3.4.1.min.js"></script>
    <script src="js/bootstrap/bootstrap.min.js"></script>
	<link rel="stylesheet" href="css/bootstrap/bootstrap.min.css">
	<link rel="stylesheet" href="css/custom.css">
	<script>
        var logs = [{}];
        
		var Chemin = "http://localhost/Projet_MEF";
		let postes = [{}];
		let references = [{}];
		let controles = [{}];
		let posteEnCours = "";
		let refEnCours = "";
		let identifiant = "1";

		async function lirePostes() {
			try {
				//let req = await fetch(Chemin + '/postes.php');
				let req = await fetch(Chemin + '/postes.php');
				//let req = ('D:\Users\jerem\Documents\Travail\Projet\PDS MEF Ferrage\meffer\postes.php');
				let json = await req.json();
				if (json.length) {
					postes = json;
					remplirTableau();
				}

			} catch (err) {
				console.log(err);
			}
		}

		async function lireRefs() {
			try {
				let req = await fetch(Chemin + '/references.php?id=' + posteEnCours);
				//let req = (Chemin + '/references.php?id=' + posteEnCours);
				let json = await req.json();
				if (json.length) {
					references = json;
					remplirRefs();
				}
			} catch (err) {
				console.log(err);
			}
		}

		async function recupererDerniersCtrl() {
			try {
				let req = await fetch(Chemin + '/lastctrl.php?id=' + posteEnCours);
				//let req = await (Chemin + '/references.php?id=' + posteEnCours);
				let json = await req.json();
				if (json.length) {
					controles = json;
					remplirDerniersCtrl();
				}
			} catch (err) {
				console.log(err);
			}
		}

		function choixRef(r) {
			$.each(references, function (i, obj) {
				console.log(obj.id + ' ' + obj.reference);
				$('#piece' + (obj.id)).removeClass("active");
			});
			$("#piece" + r).addClass("active");
			refEnCours = r;
		}

		function remplirDerniersCtrl() {
			let tableau = $('#tab_ctrl > tbody');
			tableau.html('');
			controles.map(controles => {
				tableau.append('<tr>');
				for (let prop in controles) {
					if (controles.hasOwnProperty(prop)) {
						if(controles[prop]){
							if(controles[prop] == 1){
								tableau.find('tr').last().append('<td>OK</td>');
							}
							else{
							tableau.find('tr').last().append('<td>'+ controles[prop] +'</td>');
							}
						}
						else{
							tableau.find('tr').last().append('<td>NOK</td>');
						}
					}
				
				}
			});
		}

		function remplirRefs() {
			$("#listerefs").html('');
			$.each(references, function (i, obj) {
				console.log(obj.id + ' ' + obj.reference);
				$('#listerefs').append("<li data-toggle='modal' data-target='#choixcontrole' id='piece" + obj.id + "' onclick='choixRef(" + obj.id + ")' class='list-group-item'><figure class='figure'><img class='figure-img img-fluid rounded'  width='15%' height='50%' src='img/vis.png'><figcaption class='figure-caption'>" + obj.reference + "</figcaption></figure></li>");
			});
			recupererDerniersCtrl();
		}

		function choixPoste(p) {
			posteEnCours = postes[p].id
			$("#content").html('');
			$("#poste").html(postes[p].poste);
			$("#titre").html("");
			$("#content").append("<div class='jumbotron' id='titres_main'></div>");
			$("#titres_main").append("<h1 class='text-center display-4'>MEF Ferrage historique conformité</h1><br />");
			$("#titres_main").append("<div class='jumbotron'><div class='row col-md-10 mx-auto p-4'><table id='tab_ctrl' class='table table-responsive-md table-striped table-bordered table-active text-center'></table></div></div>");
			$("#tab_ctrl").append("<thead><tr><th>#</th><th>Date/heure</th><th>Identifiant</th><th>Poste</th><th>Référence</th></th><th>Etat</th></tr></thead><tbody></tbody>");
			//lireRefs();
			recupererDerniersCtrl();
		}

		function remplirTableau() {
			$("#listepostes").html('');
			$.each(postes, function (i, obj) {
				console.log(obj.id + ' ' + obj.poste);
				if (i < 6) {
					$('#listepostes').append("<li onclick='choixPoste(" + i + ")' class='list-group-item'><figure class='figure'><img class='figure-img img-fluid rounded'  width='25%' height='100%' src='img/pc.svg'><figcaption class='figure-caption'>" + obj.poste + "</figcaption></figure></li>");
				}
				if (i > 5 && i < 12) {
					$('#content').append("<ul id='listepostes2' class='list-group list-group-horizontal justify-content-center'></ul>");
					$('#listepostes2').append("<li onclick='choixPoste(" + i + ")' class='list-group-item'><figure class='figure'><img class='figure-img img-fluid rounded'  width='25%' height='100%' src='img/pc.svg'><figcaption class='figure-caption'>" + obj.poste + "</figcaption></figure></li>");
				}
				if (i > 11) {
					$('#content').append("<ul id='listepostes3' class='list-group list-group-horizontal justify-content-center'></ul>");
					$('#listepostes3').append("<li onclick='choixPoste(" + i + ")' class='list-group-item'><figure class='figure'><img class='figure-img img-fluid rounded'  width='25%' height='100%' src='img/pc.svg'><figcaption class='figure-caption'>" + obj.poste + "</figcaption></figure></li>");
				}

			});
		}

		$(document).ready(function () {
			$('#choixcontrole').on('hidden.bs.modal', function () {
				$.each(references, function (i, obj) {
					console.log(obj.id + ' ' + obj.reference);
					$('#piece' + (obj.id)).removeClass("active");
				});
			});

			$('#nok').click(function () {
				let res = 0;
				$.ajax({
					type: 'POST',
					url: 'write.php',
					data: { "userid": identifiant, "poste": posteEnCours, "ref": refEnCours, "res": res },
					success: function (data) {
						if (data.status = "ok") {
							$("#success").show().delay(2000).fadeOut();
						} else {
							$("echec").show().delay(2000).fadeOut();
						}
					},
				});
				recupererDerniersCtrl();
			});

			$('#ok').click(function () {
				let res = 1;
				$.ajax({
					type: 'POST',
					url: 'write.php',
					data: { "userid": identifiant, "poste": posteEnCours, "ref": refEnCours, "res": res },
					success: function (data) {
						if (data.status = "ok") {
							$("#success").show().delay(2000).fadeOut();
						} else {
							$("echec").show().delay(2000).fadeOut();
						}
					}
				});
				recupererDerniersCtrl();
			});

			lirePostes();

		});

		$( document ).ready(function() {
			$.ajax({
						type: 'POST',
						url: 'read.php',
						data:  "read=y",
						success: function(data) {
							logs = data; 
							remplirLogs(logs);
						}
					});
		});

		function remplirLogs(log)
		{
			let tableau = $('#tab_logs > tbody');
			tableau.html('');
			log.map(log =>
			{
				tableau.append('<tr>');
				for (var i = 0, l = log.length; i < l; i++) 
				{
						if(log[i])
							tableau.find('tr').last().append('<td>'+ log[i] +'</td>');
						else
							tableau.find('tr').last().append('<td> - </td>');
				}
			});
        }
        
	</script>
	<title>MEF Ferrage</title>
</head>

<body>
	<header>
		<nav class="navbar navbar-expand-sm bg-dark">
			<img width="7.5%" height="7.5%" src="img/home.png">
			<a class="navbar-brand font-weight-bold" style="color : white !important" href="http://localhost/Projet_MEF/index.html">Ferrage</a>
			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
				aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse menu-texte" id="navbarSupportedContent">
				<ul class="navbar-nav mr-auto">
					<li class="nav-item active">
						<a class="nav-link" href="http://localhost/Projet_MEF/index.html">Contrôle <span class="sr-only"></span></a>
					</li>
					<li class="nav-item active">
						<a class="nav-link" href="http://localhost/Projet_MEF/logs2.html">Historique<span class="sr-only">(current)</span></a>
					</li>
				</ul>
			</div>
		</nav>
	</header>
	<main>
		<h3 class="text-center display-6" id="titre">MEF Ferrage historique conformité</h3><br />
		<!--<div id="success" class="alert alert-success" role="alert" style="display: none;">
			<h4 class="alert-heading">Succès</h4>
			<p class="mb-0">Le contrôle a bien été enregistré.</p>
		</div>
		<div id="echec" class="alert alert-danger" role="alert" style="display: none;">
			<h4 class="alert-heading">Echec</h4>
			<p class="mb-0">Erreur lors de l'écriture.</p>
		</div>-->
		<div id="content" class="jumbotron">
			<!--<h1 class='text-center display-4'>MEF Ferrage historique conformité</h1><br />-->
			<h3 class="text-left display-5">Choissisez le poste</h3><br />
			<ul id="listepostes" class="list-group list-group-horizontal justify-content-center">
			</ul>
		</div>
	</main>
	<footer>
		<div class='footer text-white bg-dark text-center p-3'>© 2019-2020
			<b><a class='text-white text-capitalize' href='https://www.groupe-psa.com/fr/'> Equipe Digitale / Groupe
					PSA</a></b>
		</div>
	</footer>
</body>

</html>